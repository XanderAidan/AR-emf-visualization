<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aether Scanner: Omni-Tool</title>
    <style>
        /* --- CYBERPUNK AESTHETIC --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-red: #ff0055;
            --neon-gold: #ffcc00;
            --neon-green: #00ff9d;
            --bg-dark: rgba(5, 5, 10, 0.9);
            --hud-border: 1px solid rgba(255, 255, 255, 0.15);
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', 'Courier New', monospace;
            background-color: #000;
            color: #fff;
            user-select: none;
        }

        /* --- SCANLINES OVERLAY --- */
        .scanlines {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
            opacity: 0.4;
        }

        /* --- INTRO SCREEN --- */
        #intro-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111 0%, #000 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            font-size: 2rem;
            letter-spacing: 4px;
            color: var(--neon-blue);
            text-shadow: 0 0 15px var(--neon-blue);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .subtitle {
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 30px;
            max-width: 300px;
            line-height: 1.4;
        }

        /* Sensor Capability Grid */
        .cap-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
            text-align: left;
            width: 100%;
            max-width: 300px;
        }

        .cap-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #aaa;
        }

        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: #333;
            margin-right: 10px;
            box-shadow: 0 0 5px #333;
            transition: 0.3s;
        }

        .ready { background: var(--neon-green); box-shadow: 0 0 8px var(--neon-green); }
        .sim { background: var(--neon-blue); box-shadow: 0 0 8px var(--neon-blue); }
        .error { background: var(--neon-red); }

        #start-btn {
            background: transparent;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 15px 40px;
            font-size: 1rem;
            letter-spacing: 2px;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }
        #start-btn:active { background: rgba(0, 243, 255, 0.2); }

        /* --- HUD --- */
        #hud {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: none; /* Hidden until start */
            z-index: 60;
        }

        .hud-panel {
            position: absolute;
            background: var(--bg-dark);
            backdrop-filter: blur(5px);
            border: var(--hud-border);
            padding: 10px 15px;
            border-radius: 4px;
            pointer-events: auto;
        }

        .top-left { top: 20px; left: 20px; border-left: 3px solid var(--neon-blue); }
        .top-right { top: 20px; right: 20px; border-right: 3px solid var(--neon-red); text-align: right; }
        .bottom-center { 
            bottom: 30px; left: 50%; 
            transform: translateX(-50%); 
            display: flex; gap: 10px; 
            background: transparent; border: none; 
        }

        .data-label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 2px; }
        .data-val { font-size: 1.2rem; font-weight: bold; font-family: monospace; }
        .c-blue { color: var(--neon-blue); }
        .c-red { color: var(--neon-red); }
        .c-gold { color: var(--neon-gold); }

        /* NFC Button */
        #nfc-btn {
            background: rgba(0,0,0,0.6);
            border: 1px solid var(--neon-gold);
            color: var(--neon-gold);
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        #nfc-btn.scanning {
            background: var(--neon-gold);
            color: #000;
            box-shadow: 0 0 15px var(--neon-gold);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        #console-log {
            position: absolute;
            bottom: 80px; left: 20px;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
            max-width: 80%;
            pointer-events: none;
            text-shadow: 1px 1px 0 #000;
        }

    </style>
</head>
<body>

    <div class="scanlines"></div>

    <!-- INTRO -->
    <div id="intro-screen">
        <h1>Aether Scanner</h1>
        <div class="subtitle">Multi-Spectrum AR Visualization Tool<br>Pixel 10 Pro XL Optimized</div>

        <div class="cap-grid">
            <div class="cap-item"><div id="s-mag" class="status-dot"></div>Magnetometer</div>
            <div class="cap-item"><div id="s-mic" class="status-dot"></div>Microphone</div>
            <div class="cap-item"><div id="s-light" class="status-dot"></div>Light Sensor</div>
            <div class="cap-item"><div id="s-nfc" class="status-dot"></div>NFC Module</div>
        </div>

        <button id="start-btn">INITIALIZE SYSTEM</button>
        <div id="ar-warning" style="margin-top:20px; font-size: 0.7rem; color:#666; display:none;">
            Note: AR features require WebXR compatible browser.
        </div>
    </div>

    <!-- HUD -->
    <div id="hud">
        <!-- Top Left: EMF & Light -->
        <div class="hud-panel top-left">
            <div style="margin-bottom: 10px;">
                <span class="data-label">MAGNETIC FLUX</span>
                <span id="val-mag" class="data-val c-blue">0 µT</span>
            </div>
            <div>
                <span class="data-label">PHOTON DENSITY</span>
                <span id="val-light" class="data-val c-blue">0 Lx</span>
            </div>
        </div>

        <!-- Top Right: Audio -->
        <div class="hud-panel top-right">
            <span class="data-label">AUDIO GAIN</span>
            <span id="val-audio" class="data-val c-red">0 dB</span>
        </div>

        <!-- Bottom: Actions -->
        <div class="hud-panel bottom-center">
            <button id="nfc-btn">ARM NFC SCANNER</button>
        </div>

        <!-- Debug Log -->
        <div id="console-log">System Standby...</div>
    </div>

    <!-- THREE.JS IMPORT MAP -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- CONFIGURATION ---
        const CONFIG = {
            spawnInterval: 100,     // ms between cloud puffs
            particleLife: 8000,     // ms before puff dies
            simMode: false          // Fallback if no sensors
        };

        // --- STATE ---
        let camera, scene, renderer;
        let particles = [];
        let beacons = [];
        let lastSpawn = 0;
        let isNfcScanning = false;

        // Sensor Values
        let sData = {
            mag: 45,        // µT (Color)
            audio: 0,       // 0-1 (Size)
            light: 200      // Lux (Opacity)
        };

        // UI References
        const ui = {
            intro: document.getElementById('intro-screen'),
            hud: document.getElementById('hud'),
            valMag: document.getElementById('val-mag'),
            valAudio: document.getElementById('val-audio'),
            valLight: document.getElementById('val-light'),
            log: document.getElementById('console-log'),
            nfcBtn: document.getElementById('nfc-btn'),
            sDots: {
                mag: document.getElementById('s-mag'),
                mic: document.getElementById('s-mic'),
                light: document.getElementById('s-light'),
                nfc: document.getElementById('s-nfc')
            }
        };

        // --- INITIALIZATION ---
        initApp();

        function initApp() {
            // Pre-check sensors
            checkSensors();

            document.getElementById('start-btn').addEventListener('click', () => {
                ui.intro.style.display = 'none';
                ui.hud.style.display = 'block';
                initThree();
                activateSensors();
            });

            ui.nfcBtn.addEventListener('click', toggleNFC);
        }

        function log(msg) {
            ui.log.innerText = "> " + msg;
            console.log(msg);
        }

        // --- SENSOR HANDLING ---
        function checkSensors() {
            if ('Magnetometer' in window) ui.sDots.mag.classList.add('ready');
            else ui.sDots.mag.classList.add('sim');

            if ('AmbientLightSensor' in window) ui.sDots.light.classList.add('ready');
            else ui.sDots.light.classList.add('sim');

            if ('NDEFReader' in window) ui.sDots.nfc.classList.add('ready');
            else ui.sDots.nfc.classList.add('error');
            
            // Mic always "ready" until permission denied
            ui.sDots.mic.classList.add('ready');
        }

        async function activateSensors() {
            // 1. Audio (Requires user gesture, which click provided)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioCtx.createAnalyser();
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 64;
                const dataArr = new Uint8Array(analyser.frequencyBinCount);

                const updateAudio = () => {
                    analyser.getByteFrequencyData(dataArr);
                    let sum = 0;
                    for(let i=0; i<dataArr.length; i++) sum += dataArr[i];
                    sData.audio = (sum / dataArr.length) / 255.0; // Norm 0-1
                    requestAnimationFrame(updateAudio);
                };
                updateAudio();
                log("Audio Uplink Active");
            } catch (e) {
                log("Audio Access Denied - Simulating");
                setInterval(() => { sData.audio = Math.random() * 0.3; }, 200);
            }

            // 2. Magnetometer
            if ('Magnetometer' in window) {
                try {
                    const mag = new Magnetometer({ frequency: 20 });
                    mag.addEventListener('reading', () => {
                        sData.mag = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                    });
                    mag.start();
                } catch(e) { log("Mag Error: " + e); }
            } else {
                setInterval(() => { sData.mag = 40 + Math.sin(Date.now()/1000)*10; }, 100);
            }

            // 3. Light Sensor
            if ('AmbientLightSensor' in window) {
                try {
                    const light = new AmbientLightSensor({ frequency: 10 });
                    light.addEventListener('reading', () => { sData.light = light.illuminance; });
                    light.start();
                } catch(e) {}
            }
        }

        async function toggleNFC() {
            if (!('NDEFReader' in window)) {
                log("NFC Hardware Not Found");
                return;
            }

            if (isNfcScanning) {
                // Cannot easily stop NDEFReader without abort controller, but for UI:
                ui.nfcBtn.classList.remove('scanning');
                ui.nfcBtn.innerText = "ARM NFC SCANNER";
                isNfcScanning = false;
                log("NFC Disarmed");
            } else {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    ui.nfcBtn.classList.add('scanning');
                    ui.nfcBtn.innerText = "SCANNING...";
                    isNfcScanning = true;
                    log("Scan tag now...");

                    ndef.addEventListener("reading", () => {
                        log("NFC TAG DETECTED!");
                        spawnNfcBeacon();
                    });
                } catch (error) {
                    log("NFC Error: " + error);
                }
            }
        }

        // --- 3D SCENE & AR ---
        function initThree() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);

            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0.5, 1, 0.25);
            scene.add(light);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            // Add standard WebXR button, but hide it visually since we use our own flow
            // Actually, we need the button to enter immersive-ar.
            const arBtn = ARButton.createButton(renderer, { requiredFeatures: ['hit-test', 'dom-overlay'], domOverlay: { root: document.body } });
            arBtn.style.position = 'absolute';
            arBtn.style.bottom = '100px'; 
            arBtn.style.opacity = '0'; // Hidden trigger
            arBtn.style.pointerEvents = 'none';
            document.body.appendChild(arBtn);
            
            // Auto-click AR button if available for seamless entry? 
            // Better to let Three.js handle it, but we can style the button generated by Three.js
            // The logic below restyles the button to match our theme
            arBtn.innerText = "ENTER AR MODE";
            arBtn.style.opacity = '1';
            arBtn.style.pointerEvents = 'auto';
            arBtn.style.background = 'rgba(0,0,0,0.8)';
            arBtn.style.border = '1px solid var(--neon-blue)';
            arBtn.style.color = 'var(--neon-blue)';
            arBtn.style.bottom = '150px'; // Move up above logs
            
            renderer.setAnimationLoop(render);
            
            // Resize handler
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // Reusable Geometries
        const cloudGeo = new THREE.IcosahedronGeometry(0.03, 1); // Base cloud particle
        const beaconGeo = new THREE.OctahedronGeometry(0.05, 0); // NFC Beacon

        function render(timestamp, frame) {
            updateHUD();

            // Only spawn if in AR (or strict sim mode)
            if (renderer.xr.isPresenting || CONFIG.simMode) {
                if (timestamp - lastSpawn > CONFIG.spawnInterval) {
                    spawnCloud();
                    lastSpawn = timestamp;
                }
            }

            // Animate Particles
            const time = timestamp * 0.001;
            
            // Clouds
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                let age = timestamp - p.userData.birth;
                if (age > CONFIG.particleLife) {
                    scene.remove(p);
                    p.material.dispose();
                    particles.splice(i, 1);
                } else {
                    p.material.opacity = p.userData.baseOp * (1 - (age / CONFIG.particleLife));
                    p.rotation.x = time + p.userData.offset;
                    p.rotation.y = time * 0.5;
                }
            }

            // Beacons (NFC)
            beacons.forEach(b => {
                b.rotation.y += 0.05;
                b.rotation.x += 0.02;
                b.scale.setScalar(1 + Math.sin(time * 5) * 0.2); // Pulse
            });

            renderer.render(scene, camera);
        }

        function updateHUD() {
            ui.valMag.innerText = sData.mag.toFixed(1) + " µT";
            ui.valAudio.innerText = Math.round(sData.audio * 100) + " %";
            ui.valLight.innerText = Math.round(sData.light) + " Lx";

            // Dynamic Styling
            ui.valMag.style.color = sData.mag > 60 ? 'var(--neon-red)' : 'var(--neon-blue)';
        }

        function spawnCloud() {
            const pos = getSpawnPosition();
            
            // Visuals Logic
            // Color = Magnetometer (Blue->Red)
            const magNorm = Math.min(Math.max((sData.mag - 30)/100, 0), 1);
            const color = new THREE.Color().lerpColors(new THREE.Color(0x00f3ff), new THREE.Color(0xff0055), magNorm);

            // Size = Audio
            const size = 1.0 + (sData.audio * 4.0);

            // Opacity = Light (Darker room = Fainter ghost, Bright room = Solid)
            // Or inverse? Let's make bright light = more transparent "ether"
            const opacity = Math.min(Math.max(sData.light / 500, 0.3), 0.9);

            const mat = new THREE.MeshBasicMaterial({
                color: color,
                transparent: true,
                opacity: opacity,
                wireframe: true
            });

            const mesh = new THREE.Mesh(cloudGeo, mat);
            mesh.position.copy(pos);
            mesh.scale.set(size, size, size);
            mesh.userData = { birth: performance.now(), baseOp: opacity, offset: Math.random() };

            scene.add(mesh);
            particles.push(mesh);
        }

        function spawnNfcBeacon() {
            // Spawn a permanent gold marker at current location
            const pos = getSpawnPosition();
            const mat = new THREE.MeshBasicMaterial({ color: 0xffcc00, wireframe: true });
            const beacon = new THREE.Mesh(beaconGeo, mat);
            beacon.position.copy(pos);
            scene.add(beacon);
            beacons.push(beacon);
        }

        function getSpawnPosition() {
            const vec = new THREE.Vector3();
            if (renderer.xr.isPresenting) {
                const camPos = new THREE.Vector3();
                const camQuat = new THREE.Quaternion();
                camera.getWorldPosition(camPos);
                camera.getWorldQuaternion(camQuat);
                const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camQuat);
                vec.copy(camPos).add(dir.multiplyScalar(0.3)); // 30cm in front
            } else {
                // Sim mode orbit
                const t = Date.now() * 0.001;
                vec.set(Math.sin(t)*0.5, 0, Math.cos(t)*0.5);
            }
            return vec;
        }

    </script>
</body>
</html>


