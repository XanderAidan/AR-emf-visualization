<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sensor Fusion HUD</title>
    <style>
        /* --- CORE LAYOUT --- */
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        /* Camera Feed Layer */
        #camera-feed {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        /* Visualization Layer */
        #hud-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
        }

        /* UI Text Layer */
        #ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 3;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- UI ELEMENTS --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-top: 2px solid #00f3ff;
            backdrop-filter: blur(4px);
        }

        .sensor-readout {
            text-align: center;
        }
        
        .label { font-size: 10px; color: #aaa; letter-spacing: 1px; text-transform: uppercase; }
        .value { font-size: 18px; font-weight: bold; color: #fff; }
        .unit { font-size: 10px; color: #00f3ff; }

        /* The EMF Reticle */
        #reticle {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 200px; height: 200px;
            border: 2px solid rgba(0, 243, 255, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
            transition: border-color 0.2s, box-shadow 0.2s, width 0.2s, height 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Crosshairs inside reticle */
        #reticle::after {
            content: '';
            width: 10px; height: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        /* Dynamic Color Classes */
        .safe { color: #00f3ff; border-color: #00f3ff; }
        .warn { color: #ffcc00; border-color: #ffcc00; }
        .danger { color: #ff0055; border-color: #ff0055; }

        /* Start Button overlay */
        #start-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #00f3ff;
        }
        
        button {
            background: transparent;
            color: #00f3ff;
            border: 1px solid #00f3ff;
            padding: 15px 40px;
            font-size: 16px;
            margin-top: 20px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Scanning effect */
        .scan-line {
            position: absolute;
            width: 100%; height: 2px;
            background: rgba(0, 243, 255, 0.5);
            animation: scan 3s linear infinite;
            pointer-events: none;
            z-index: 4;
            display: none; /* Active only when running */
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        #nfc-alert {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -150%);
            background: rgba(255, 204, 0, 0.9);
            color: #000;
            padding: 10px 20px;
            font-weight: bold;
            display: none;
            border-radius: 4px;
            box-shadow: 0 0 20px #ffcc00;
        }

    </style>
</head>
<body>

    <!-- VIDEO BACKGROUND -->
    <video id="camera-feed" autoplay playsinline muted></video>

    <!-- CANVAS FOR WAVEFORMS -->
    <canvas id="hud-canvas"></canvas>

    <!-- UI LAYER -->
    <div id="ui-layer" style="display:none;">
        
        <!-- Top Data Bar -->
        <div class="top-bar">
            <div class="sensor-readout">
                <div class="label">MAG FIELD</div>
                <div id="val-mag" class="value safe">0</div>
                <div class="unit">ÂµT</div>
            </div>
            <div class="sensor-readout">
                <div class="label">LIGHT</div>
                <div id="val-lux" class="value">0</div>
                <div class="unit">LUX</div>
            </div>
            <div class="sensor-readout">
                <div class="label">AUDIO</div>
                <div id="val-db" class="value">0</div>
                <div class="unit">dB</div>
            </div>
        </div>

        <!-- Center Element -->
        <div id="reticle"></div>
        <div id="nfc-alert">NFC TAG DETECTED</div>

        <!-- Bottom - Placeholder for Graph Alignment -->
        <div style="height: 100px; width: 100%;"></div> 
        
        <div class="scan-line" id="scan-line"></div>
    </div>

    <!-- START SCREEN -->
    <div id="start-overlay">
        <h1>SENSOR FUSION HUD</h1>
        <div style="font-size: 12px; color: #666; margin-bottom: 20px;">PIXEL 10 PRO XL OPTIMIZED</div>
        <div id="status-log" style="font-size: 10px; color: #888; margin-bottom: 20px; max-width: 300px; text-align: center;">Waiting for initialization...</div>
        <button id="init-btn">ACTIVATE SENSORS</button>
    </div>

    <script>
        // --- CONFIG ---
        const CONFIG = {
            magSafe: 40,
            magWarn: 60,
            magDanger: 100,
            simMode: false // Auto-enables if sensors missing
        };

        // --- STATE ---
        const state = {
            mag: 45,
            lux: 200,
            audioVol: 0, // 0.0 - 1.0
            audioHighFreq: 0,
            waveform: new Uint8Array(128)
        };

        // --- DOM REFS ---
        const ui = {
            video: document.getElementById('camera-feed'),
            canvas: document.getElementById('hud-canvas'),
            uiLayer: document.getElementById('ui-layer'),
            startOverlay: document.getElementById('start-overlay'),
            initBtn: document.getElementById('init-btn'),
            status: document.getElementById('status-log'),
            valMag: document.getElementById('val-mag'),
            valLux: document.getElementById('val-lux'),
            valDb: document.getElementById('val-db'),
            reticle: document.getElementById('reticle'),
            scanLine: document.getElementById('scan-line'),
            nfcAlert: document.getElementById('nfc-alert')
        };

        // --- INITIALIZATION ---
        ui.initBtn.addEventListener('click', startApp);

        async function startApp() {
            ui.status.innerText = "Requesting Camera & Sensor Access...";
            
            try {
                // 1. Camera Access (Environment/Rear Camera)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false // Audio captured separately for analysis
                });
                ui.video.srcObject = stream;
                
                // 2. Audio Analysis Access
                setupAudio();

                // 3. Hardware Sensors
                setupHardwareSensors();

                // 4. Start NFC (If user clicks button again or separate trigger, but we'll arm it)
                setupNFC();

                // 5. UI Transition
                ui.startOverlay.style.display = 'none';
                ui.uiLayer.style.display = 'flex';
                ui.scanLine.style.display = 'block';

                // 6. Start Render Loop
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                requestAnimationFrame(renderLoop);

            } catch (err) {
                ui.status.innerText = "Error: " + err.message + "\n(Ensure HTTPS and Permissions)";
                console.error(err);
                // Fallback to Sim Mode
                setTimeout(() => {
                    CONFIG.simMode = true;
                    ui.startOverlay.style.display = 'none';
                    ui.uiLayer.style.display = 'flex';
                    ui.video.style.background = '#222'; // Grey background if no cam
                    requestAnimationFrame(renderLoop);
                }, 2000);
            }
        }

        // --- SENSORS ---

        async function setupAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = ctx.createAnalyser();
                const src = ctx.createMediaStreamSource(stream);
                src.connect(analyser);
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const update = () => {
                    analyser.getByteTimeDomainData(dataArray); // Waveform
                    state.waveform = dataArray;
                    
                    // Volume Calc
                    let sum = 0;
                    for(let i=0; i<dataArray.length; i++) {
                        const v = (dataArray[i] - 128) / 128.0;
                        sum += v*v;
                    }
                    state.audioVol = Math.sqrt(sum / dataArray.length); // RMS
                    
                    requestAnimationFrame(update);
                }
                update();
            } catch(e) {
                console.warn("Audio failed", e);
            }
        }

        function setupHardwareSensors() {
            // Magnetometer
            if ('Magnetometer' in window) {
                try {
                    const mag = new Magnetometer({ frequency: 60 });
                    mag.addEventListener('reading', () => {
                        state.mag = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                    });
                    mag.start();
                } catch (e) { console.warn("Mag sensor error", e); CONFIG.simMode = true; }
            } else { CONFIG.simMode = true; }

            // Light
            if ('AmbientLightSensor' in window) {
                try {
                    const light = new AmbientLightSensor({ frequency: 10 });
                    light.addEventListener('reading', () => { state.lux = light.illuminance; });
                    light.start();
                } catch(e) {}
            }
        }

        async function setupNFC() {
            if ('NDEFReader' in window) {
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();
                    ndef.addEventListener("reading", () => {
                        // Flash UI
                        ui.nfcAlert.style.display = 'block';
                        setTimeout(() => ui.nfcAlert.style.display = 'none', 3000);
                    });
                } catch(e) { console.log("NFC Error", e); }
            }
        }

        // --- RENDER LOOP ---

        function resizeCanvas() {
            ui.canvas.width = window.innerWidth;
            ui.canvas.height = window.innerHeight;
        }

        function renderLoop() {
            const ctx = ui.canvas.getContext('2d');
            const w = ui.canvas.width;
            const h = ui.canvas.height;

            // Clear previous frame
            ctx.clearRect(0, 0, w, h);

            // 1. Simulation Data Fallback
            if (CONFIG.simMode) {
                const t = Date.now() / 1000;
                state.mag = 45 + Math.sin(t)*15 + Math.cos(t*3)*10;
                state.audioVol = (Math.sin(t*10)+1)*0.1;
                // Generate fake waveform
                for(let i=0; i<state.waveform.length; i++) {
                    state.waveform[i] = 128 + Math.sin(i*0.2 + t*10)*30;
                }
            }

            // 2. Update Text UI
            ui.valMag.innerText = state.mag.toFixed(1);
            ui.valLux.innerText = state.lux.toFixed(0);
            ui.valDb.innerText = (state.audioVol * 100).toFixed(0);

            // 3. Reticle Logic (EMF)
            // Color Mapping
            let color = '#00f3ff'; // Safe
            if (state.mag > CONFIG.magWarn) color = '#ffcc00'; // Warn
            if (state.mag > CONFIG.magDanger) color = '#ff0055'; // Danger

            // Apply to CSS
            ui.reticle.style.borderColor = color;
            ui.reticle.style.boxShadow = `0 0 ${state.mag/2}px ${color}`;
            ui.valMag.style.color = color;

            // Pulse Size based on Strength
            const scale = 1 + (state.mag - 40)/200; 
            ui.reticle.style.transform = `translate(-50%, -50%) scale(${scale})`;

            // 4. Draw Audio Waveform (Bottom)
            ctx.lineWidth = 2;
            ctx.strokeStyle = color; // Sync waveform color to EMF danger level for effect
            ctx.beginPath();
            
            const sliceWidth = w * 1.0 / state.waveform.length;
            let x = 0;
            const yOffset = h - 100; // Draw 100px from bottom

            for(let i = 0; i < state.waveform.length; i++) {
                const v = state.waveform[i] / 128.0;
                const y = v * 50 + (h - 150); // Amplitude 50
                
                if(i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
                x += sliceWidth;
            }
            ctx.lineTo(w, h/2);
            ctx.stroke();

            // 5. Light Sensor Vignette
            // Darker room (low lux) = More UI Glow / Brighter Overlay
            // Bright room (high lux) = Darker Overlay to see screen
            // Or visualize light intensity as a white alpha overlay
            // Let's use it to dim the edges.
            const vignetteOpacity = Math.max(0, Math.min(1 - (state.lux / 500), 0.8));
            const gradient = ctx.createRadialGradient(w/2, h/2, h/4, w/2, h/2, h);
            gradient.addColorStop(0, "rgba(0,0,0,0)");
            gradient.addColorStop(1, `rgba(0,0,0,${vignetteOpacity})`);
            ctx.fillStyle = gradient;
            ctx.fillRect(0,0,w,h);

            requestAnimationFrame(renderLoop);
        }

    </script>
</body>
</html>
