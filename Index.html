<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Aether Scanner: Heatmap</title>
    <style>
        :root {
            --hud-bg: rgba(10, 10, 16, 0.85);
            --neon-blue: #00f3ff;
            --neon-green: #00ff9d;
            --neon-red: #ff0055;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', monospace;
            background-color: #000;
            color: #fff;
            user-select: none;
        }

        /* --- HUD LAYOUT --- */
        #hud {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: none;
            z-index: 10;
        }

        .panel {
            position: absolute;
            background: var(--hud-bg);
            backdrop-filter: blur(4px);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .top-bar {
            top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px;
            white-space: nowrap;
        }

        .stat-box { text-align: center; }
        .label { font-size: 0.6rem; color: #888; letter-spacing: 1px; }
        .val { font-size: 1.1rem; font-weight: bold; font-family: 'Courier New', monospace; }

        .c-safe { color: var(--neon-blue); }
        .c-warn { color: #ffcc00; }
        .c-danger { color: var(--neon-red); }

        /* Color Scale Legend */
        .legend {
            position: absolute;
            bottom: 30px; right: 20px;
            width: 10px; height: 150px;
            background: linear-gradient(to top, var(--neon-blue), var(--neon-green), #ffcc00, var(--neon-red));
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        .legend::after {
            content: 'MAX'; position: absolute; top: -15px; left: -10px; font-size: 0.6rem;
        }
        .legend::before {
            content: 'MIN'; position: absolute; bottom: -15px; left: -10px; font-size: 0.6rem;
        }

        /* Intro Screen */
        #intro {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        button {
            background: transparent;
            color: var(--neon-blue);
            border: 2px solid var(--neon-blue);
            padding: 15px 30px;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="intro">
        <h1 style="color: var(--neon-blue);">AETHER MAPPER</h1>
        <p style="color: #666; font-size: 0.8rem;">EMF & ULTRASOUND VISUALIZER</p>
        <button id="start-btn">INITIALIZE AR</button>
    </div>

    <div id="hud">
        <div class="panel top-bar">
            <div class="stat-box">
                <div class="label">EMF (ÂµT)</div>
                <div id="val-mag" class="val c-safe">0.0</div>
            </div>
            <div class="stat-box">
                <div class="label">ULTRASOUND</div>
                <div id="val-ultra" class="val c-safe">LOW</div>
            </div>
        </div>
        <div class="legend"></div>
    </div>

    <!-- Three.js Imports -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- CONFIG ---
        const CONFIG = {
            spawnRate: 50,      // ms (Faster for smoother trail)
            particleLife: 15000, // Trail stays longer (15s)
            magMin: 30,         // Blue
            magMax: 100,        // Red
        };

        // --- STATE ---
        let camera, scene, renderer;
        let particles = [];
        let lastSpawn = 0;
        
        let sData = {
            mag: 40,
            ultrasound: 0 // 0.0 to 1.0
        };

        const textureLoader = new THREE.TextureLoader();
        // Create a soft glow texture programmatically
        const canvas = document.createElement('canvas');
        canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(16,16,0, 16,16,16);
        grad.addColorStop(0, 'rgba(255,255,255,1)');
        grad.addColorStop(1, 'rgba(255,255,255,0)');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,32,32);
        const glowTexture = new THREE.CanvasTexture(canvas);

        init();

        function init() {
            const btn = document.getElementById('start-btn');
            btn.addEventListener('click', () => {
                document.getElementById('intro').style.display = 'none';
                document.getElementById('hud').style.display = 'block';
                setupSensors();
                setupThree();
            });
        }

        async function setupSensors() {
            // 1. Magnetometer
            if ('Magnetometer' in window) {
                try {
                    const mag = new Magnetometer({ frequency: 60 });
                    mag.addEventListener('reading', () => {
                        sData.mag = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                        updateHUD();
                    });
                    mag.start();
                } catch(e) { console.log("Mag error", e); }
            } else {
                // Sim mode
                setInterval(() => {
                    sData.mag = 40 + Math.sin(Date.now()/1000)*30; 
                    updateHUD();
                }, 100);
            }

            // 2. Ultrasound (High Frequency Audio)
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = audioCtx.createAnalyser();
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 64; // 32 bins
                const data = new Uint8Array(analyser.frequencyBinCount);

                const loop = () => {
                    analyser.getByteFrequencyData(data);
                    // Check top 25% of frequencies (approx 15kHz - 24kHz)
                    let sum = 0;
                    const startBin = Math.floor(data.length * 0.75);
                    for(let i=startBin; i<data.length; i++) sum += data[i];
                    
                    // Normalize (High freq is usually very quiet, so amplify)
                    sData.ultrasound = Math.min((sum / (data.length - startBin)) / 30.0, 1.0);
                    
                    requestAnimationFrame(loop);
                };
                loop();
            } catch(e) {}
        }

        function updateHUD() {
            const uiMag = document.getElementById('val-mag');
            uiMag.innerText = sData.mag.toFixed(1);
            
            // Color Logic
            if(sData.mag < 50) uiMag.className = "val c-safe";
            else if(sData.mag < 80) uiMag.className = "val c-warn";
            else uiMag.className = "val c-danger";

            const uiUltra = document.getElementById('val-ultra');
            if(sData.ultrasound > 0.5) {
                uiUltra.innerText = "DETECTED";
                uiUltra.className = "val c-danger";
            } else {
                uiUltra.innerText = "LOW";
                uiUltra.className = "val c-safe";
            }
        }

        function setupThree() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);

            const arBtn = ARButton.createButton(renderer, { 
                requiredFeatures: ['hit-test', 'dom-overlay'], 
                domOverlay: { root: document.body } 
            });
            document.body.appendChild(arBtn);

            renderer.setAnimationLoop(render);
        }

        // Reusable material for particles (using Additive Blending for "Heatmap" look)
        const particleMat = new THREE.PointsMaterial({
            size: 0.15, // 15cm dots
            map: glowTexture,
            transparent: true,
            opacity: 0.8,
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        // Geometry buffer for particles
        const MAX_POINTS = 1000;
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(MAX_POINTS * 3);
        const colors = new Float32Array(MAX_POINTS * 3);
        const sizes = new Float32Array(MAX_POINTS); // For ultrasound jitter
        
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        
        // We will manually manage the "active" particles
        const particleSystem = new THREE.Points(geometry, particleMat);
        // Ensure standard frustum culling doesn't hide it if bounding box is old
        particleSystem.frustumCulled = false; 
        scene.add(particleSystem);

        let particleCount = 0;
        let pData = []; // Store metadata (birth time, etc)

        function render(timestamp, frame) {
            // Spawn Logic
            if ((renderer.xr.isPresenting || true) && (timestamp - lastSpawn > CONFIG.spawnRate)) {
                spawnParticle();
                lastSpawn = timestamp;
            }

            // Update Geometry
            const posAttr = geometry.attributes.position;
            const colAttr = geometry.attributes.color;

            // Shift Array or Ring Buffer? For simplicity, we just rebuild arrays or use a rolling index.
            // Let's standard array management for readability:
            
            // 1. Remove old particles
            for (let i = pData.length - 1; i >= 0; i--) {
                if (timestamp - pData[i].birth > CONFIG.particleLife) {
                    pData.splice(i, 1);
                }
            }

            // 2. Update Buffer Attributes
            for (let i = 0; i < pData.length; i++) {
                const p = pData[i];
                
                // Jitter effect if Ultrasound detected
                let jitterX = 0, jitterY = 0;
                if (p.ultra > 0.2) {
                    const amount = p.ultra * 0.02;
                    jitterX = (Math.random()-0.5) * amount;
                    jitterY = (Math.random()-0.5) * amount;
                }

                positions[i*3] = p.x + jitterX;
                positions[i*3+1] = p.y + jitterY;
                positions[i*3+2] = p.z;

                colors[i*3] = p.r;
                colors[i*3+1] = p.g;
                colors[i*3+2] = p.b;
            }

            geometry.setDrawRange(0, pData.length);
            posAttr.needsUpdate = true;
            colAttr.needsUpdate = true;

            renderer.render(scene, camera);
        }

        function spawnParticle() {
            if (pData.length >= MAX_POINTS) pData.shift(); // Remove oldest

            // Get Position
            const vec = new THREE.Vector3();
            if (renderer.xr.isPresenting) {
                const camPos = new THREE.Vector3(); 
                const camQuat = new THREE.Quaternion();
                camera.getWorldPosition(camPos);
                camera.getWorldQuaternion(camQuat);
                vec.copy(camPos).add(new THREE.Vector3(0, -0.2, -0.5).applyQuaternion(camQuat));
            } else {
                // Sim Orbit
                const t = Date.now() * 0.001;
                vec.set(Math.sin(t)*0.5, Math.cos(t)*0.2, Math.cos(t*0.5)*0.5);
            }

            // Calculate Color (Heatmap Gradient)
            // Normalized 0 to 1
            const t = Math.min(Math.max((sData.mag - CONFIG.magMin) / (CONFIG.magMax - CONFIG.magMin), 0), 1);
            
            // Heatmap: Blue -> Green -> Red
            const color = new THREE.Color();
            if (t < 0.5) {
                // Blue to Green
                color.lerpColors(new THREE.Color(0x00f3ff), new THREE.Color(0x00ff00), t * 2);
            } else {
                // Green to Red
                color.lerpColors(new THREE.Color(0x00ff00), new THREE.Color(0xff0000), (t - 0.5) * 2);
            }

            pData.push({
                x: vec.x, y: vec.y, z: vec.z,
                r: color.r, g: color.g, b: color.b,
                ultra: sData.ultrasound,
                birth: performance.now()
            });
        }
    </script>
</body>
</html>
